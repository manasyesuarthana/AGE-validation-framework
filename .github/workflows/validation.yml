name: "AGE Security & Performance Validation"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate_simulation:
    runs-on: ubuntu-latest

    steps:
      - name: "1. Checkout Code"
        uses: actions/checkout@v4

      - name: "2. Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "2.5. Install Docker Compose"
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: "3. Build Sensor & Attacker Images"
        run: |
          docker-compose build

      - name: "4. Run Simulations (Baseline, Padding, AGE)"
        run: |
          mkdir -p ./build/metrics/baseline
          mkdir -p ./build/metrics/padding
          mkdir -p ./build/metrics/age
          
          chmod -R 777 ./build/metrics

          # --- 1. Run Insecure Baseline ---
          echo "Running Baseline..."
          DEFENSE_MODE=baseline docker-compose run --rm \
            -v $(pwd)/build/metrics/baseline:/data_out \
            attacker
            
          # --- 2. Run Padding Defense ---
          echo "Running Padding..."
          DEFENSE_MODE=padding docker-compose run --rm \
            -v $(pwd)/build/metrics/padding:/data_out \
            attacker

          # --- 3. Run Full AGE Defense ---
          echo "Running AGE..."
          DEFENSE_MODE=age docker-compose run --rm \
            -v $(pwd)/build/metrics/age:/data_out \
            attacker

      - name: "5. Archive Simulation Metrics"
        uses: actions/upload-artifact@v4
        with:
          name: simulation-metrics
          path: ./build/metrics/

      - name: "6. Security & Performance Gate (The 'Assert')"
        run: |
          echo "--- Validating Security & Performance Metrics ---"
          
          BASELINE_FILE="./build/metrics/baseline/metrics.json"
          PADDING_FILE="./build/metrics/padding/metrics.json"
          AGE_FILE="./build/metrics/age/metrics.json"
          
          if [[ ! -f "$BASELINE_FILE" || ! -f "$PADDING_FILE" || ! -f "$AGE_FILE" ]]; then
            echo "CRITICAL_ERROR: One or more metric files were not generated."
            echo "Listing ./build/metrics:"
            ls -R ./build/metrics
            exit 1
          fi
          
          # Baseline
          BASE_NMI=$(jq -r '.nmi' $BASELINE_FILE)
          BASE_ACC=$(jq -r '.attacker_accuracy' $BASELINE_FILE)
          BASE_ENG=$(jq -r '.simulated_energy' $BASELINE_FILE)
          
          # Padding
          PAD_NMI=$(jq -r '.nmi' $PADDING_FILE)
          PAD_ENG=$(jq -r '.simulated_energy' $PADDING_FILE)
          
          # AGE
          AGE_NMI=$(jq -r '.nmi' $AGE_FILE)
          AGE_ACC=$(jq -r '.attacker_accuracy' $AGE_FILE)
          AGE_ENG=$(jq -r '.simulated_energy' $AGE_FILE)
          
          echo -e "\n========================================================="
          echo -e "   FINAL VALIDATION REPORT"
          echo -e "========================================================="
          printf "%-15s | %-10s | %-10s | %-15s\n" "STRATEGY" "NMI" "ACCURACY" "ENERGY (mJ)"
          echo "---------------------------------------------------------"
          printf "%-15s | %-10.4f | %-10.4f | %-15.4f\n" "Baseline" $BASE_NMI $BASE_ACC $BASE_ENG
          printf "%-15s | %-10.4f | %-10s | %-15.4f\n" "Padding" $PAD_NMI "N/A" $PAD_ENG
          printf "%-15s | %-10.4f | %-10.4f | %-15.4f\n" "AGE (Ours)" $AGE_NMI $AGE_ACC $AGE_ENG
          echo -e "=========================================================\n"
          
          # These checks automatically fail the pipeline if the science is wrong.
          
          FAIL=0
          
          # Assertion A: Baseline MUST be insecure (Verify the Attack works)
          # Expect NMI > 0.4 [cite: 241] (Linear policy on Epilepsy leaks info)
          if (( $(echo "$BASE_NMI < 0.4" | bc -l) )); then
            echo "[BASELINE CHECK] ASSERTION FAILED: Baseline NMI ($BASE_NMI) is too low. Attack may be broken."
            FAIL=1
          else
            echo "[BASELINE CHECK] Baseline is insecure as expected (NMI: $BASE_NMI)."
          fi
          
          # Assertion B: AGE MUST be secure (Verify the Defense works)
          # [cite_start]Expect NMI near 0 (fixed length) [cite: 91]
          if (( $(echo "$AGE_NMI > 0.05" | bc -l) )); then
            echo "[AGE CHECK] ASSERTION FAILED: AGE NMI ($AGE_NMI) indicates leakage!"
            FAIL=1
          else
            echo "[AGE CHECK] AGE defense is secure (NMI: $AGE_NMI)."
          fi
          
          # Assertion C: AGE MUST be more efficient than Padding
          # [cite_start]Expect AGE Energy < Padding Energy [cite: 94]
          if (( $(echo "$AGE_ENG >= $PAD_ENG" | bc -l) )); then
            echo "[PADDING CHECK] ASSERTION FAILED: AGE Energy ($AGE_ENG) is not better than Padding ($PAD_ENG)."
            FAIL=1
          else
            echo "[PADDING CHECK] AGE is more efficient than Padding ($AGE_ENG mJ < $PAD_ENG mJ)."
          fi
          
          # If the assumption is incorrect, the pipeline fails
          if [ $FAIL -eq 1 ]; then
            echo "CRITICAL: Validation Gate Failed."
            exit 1
          else
            echo "SUCCESS: All security and performance criteria met."
            exit 0
          fi